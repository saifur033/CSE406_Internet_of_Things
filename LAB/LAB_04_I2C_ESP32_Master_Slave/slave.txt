// ESP32 I2C Slave - XOR checksum ACK + debug prints
#include <Wire.h>

#define I2C_DEV_ADDR 0x55   // 7-bit slave address
#define SDA_PIN 21
#define SCL_PIN 22

volatile uint32_t rx_count = 0;
volatile uint8_t last_checksum = 0;

void onReceive(int len) {
  uint8_t sum = 0;
  Serial.printf("onReceive[%d]: ", len);
  while (Wire.available()) {
    uint8_t b = Wire.read();
    sum ^= b;
    Serial.write(b); // raw payload echo on Serial for logs
  }
  Serial.println();
  last_checksum = sum;
  rx_count++;
}

void onRequest() {
  Wire.write(last_checksum);  // 1-byte ACK
  Serial.println("onRequest fired (ACK sent)");
}

void setup() {
  Serial.begin(115200);
  while (!Serial) {}
  delay(200);
  Serial.println("I2C Slave ready");
  Wire.onReceive(onReceive);
  Wire.onRequest(onRequest);
  Wire.begin((uint8_t)I2C_DEV_ADDR, SDA_PIN, SCL_PIN);
}

void loop() {
  static uint32_t t0 = 0;
  if (millis() - t0 > 2000) {
    t0 = millis();
    Serial.printf("rx_count=%lu\n", (unsigned long)rx_count);
  }
}
